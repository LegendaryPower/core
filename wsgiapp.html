

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The WSGI Application &mdash; Nagare 0.5.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Nagare 0.5.1 documentation" href="index.html"/>
        <link rel="next" title="Internationalization of applications" href="i18n.html"/>
        <link rel="prev" title="Significative “RESTful” URLs" href="restful.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/logo.png" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="description.html">Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Using it</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">QuickStart</a></li>
<li class="toctree-l1"><a class="reference internal" href="framework_installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="framework_upgrade.html">Upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="nagare-admin.html">nagare-admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration_file.html">Application configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="publisher_file.html">Publisher configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Application deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="third_party.html">Third party applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial1.html">Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial2.html">Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial3.html">Part 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial4.html">Part 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="wiki_tutorial.html">Wiki</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="application_creation.html">Application creation</a></li>
<li class="toctree-l1"><a class="reference internal" href="presentation.html">Presentation service</a></li>
<li class="toctree-l1"><a class="reference internal" href="components.html">Components model</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="callbacks_forms.html">Callbacks and forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="renderer.html">Renderers</a></li>
<li class="toctree-l1"><a class="reference internal" href="restful.html">Significative URLs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">WSGI Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-nagare-handles-a-client-request">How Nagare handles a client request</a></li>
<li class="toctree-l2"><a class="reference internal" href="#customizing-the-wsgiapp">Customizing the WSGIApp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#some-examples">Some examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#reading-a-specific-configuration-section-to-initialize-a-service">Reading a specific configuration section to initialize a service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authenticating-users">Authenticating users</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-a-locale-in-each-request">Installing a locale in each request</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serving-an-application-in">Serving an application in /</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging-unhandled-exceptions">Logging unhandled exceptions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="i18n.html">Internationalization and localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="log.html">Log service</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_references.html">Object references</a></li>
<li class="toctree-l1"><a class="reference internal" href="entry_points.html">Entry points</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="demo_installation.html">Demo installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_upgrade.html">Demo upgrade</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Nagare</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>The WSGI Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-wsgi-application">
<h1>The WSGI Application<a class="headerlink" href="#the-wsgi-application" title="Permalink to this headline">¶</a></h1>
<p>When you create an application using the <code class="docutils literal notranslate"><span class="pre">nagare-admin</span> <span class="pre">create-app</span></code> command (see <a class="reference internal" href="application_creation.html"><span class="doc">Create an application</span></a>
for more details), Nagare automatically creates a class which acts as the <em>root component</em> of your
application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
      <span class="o">...</span>
      <span class="n">entry_points</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      [nagare.applications]</span>
<span class="s2">      myapp = myapp.app:app</span>
<span class="s2">      &quot;&quot;&quot;</span>
      <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># root component of the application</span>
    <span class="k">pass</span>

<span class="nd">@presentation.render_for</span><span class="p">(</span><span class="n">Root</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># some rendering code...</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">root</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Root</span>
</pre></div>
</div>
<p>Under the hood, Nagare automatically wraps this <em>root component</em> in a <a class="reference internal" href="source/nagare.html#nagare.wsgi.WSGIApp" title="nagare.wsgi.WSGIApp"><code class="xref py py-class docutils literal notranslate"><span class="pre">nagare.wsgi.WSGIApp</span></code></a> instance
via the <a class="reference internal" href="source/nagare.html#nagare.wsgi.create_WSGIApp" title="nagare.wsgi.create_WSGIApp"><code class="xref py py-class docutils literal notranslate"><span class="pre">nagare.wsgi.create_WSGIApp</span></code></a> function).
The <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> is the plumbing between the <a class="reference external" href="http://www.wsgi.org">WSGI protocol</a> and Nagare’s component API (<a class="reference internal" href="source/nagare.html#module-nagare.component" title="nagare.component"><code class="xref py py-mod docutils literal notranslate"><span class="pre">nagare.component</span></code></a>):
it exposes a WSGI interface to the host server (i.e. a <em>publisher</em> in Nagare terms) and maps the incoming
requests to components updates and rendering. So, in short, the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> implements the WSGI application that
serves your Nagare components as Web pages.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> provides some smart defaults for the common use-cases: there’s no authentication by default, a
default locale is used so that localizable strings are returned as is, the exceptions that occur while
processing your components are hidden behind a HTTP Internal Server Error, etc.</p>
<p>However, sometimes, you want to override this default application behavior: for example, you may want to use a user
authentication scheme, show custom error pages when exceptions occur, initialize something in each request, change
the locale, … We are going to show you how to do that, but we must first explain how Nagare handles a client request
so that you can understand how to customize the application behavior.</p>
<div class="section" id="how-nagare-handles-a-client-request">
<h2>How Nagare handles a client request<a class="headerlink" href="#how-nagare-handles-a-client-request" title="Permalink to this headline">¶</a></h2>
<p>When the WSGI server receives a client request, it calls the <code class="xref py py-class docutils literal notranslate"><span class="pre">nagare.wsgi.WSGIApp.__call__</span></code>
method of the application, which returns the content of the response for this request, as described
in the <a class="reference external" href="http://www.wsgi.org">WSGI protocol</a>. This is where Nagare does all the work so that your components are served as a Web pages on
top of WSGI.</p>
<p>First, Nagare analyzes the incoming request in order to retrieve the session information (i.e. which user is
sending the request to the server), and (eventually) the action the user triggered on the last page he visited.</p>
<p>The session information is represented by the <code class="docutils literal notranslate"><span class="pre">_s</span></code> and <code class="docutils literal notranslate"><span class="pre">_c</span></code> parameters of the URL. If the session information is
either missing, expired or invalid, Nagare creates a new session and sets up the initial state of the application by
calling the root component factory (i.e. the function passed to the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> constructor). This factory returns an
instance of the root component that, once rendered, will be the first page the user will see. Otherwise, Nagare uses the
session information to load the corresponding session data and initializes the components state from this data, which
effectively put the components in the same setup as in the previous page.</p>
<p>When significative URLs are used (see <a class="reference internal" href="restful.html"><span class="doc">Significative “RESTful” URLs</span></a>), the URL is used to initialize the state of the components when
a new session is created and is ignored otherwise (because the session data carries more state information than the URL
itself).</p>
<p>Once the components are initialized, Nagare finds and executes the action callback (represented by the <code class="docutils literal notranslate"><span class="pre">_actionNNN</span></code>
parameter of the URL, where <code class="docutils literal notranslate"><span class="pre">NNN</span></code> is a random number) which updates the state of the components to reflect the consequences
of the action (see <a class="reference internal" href="callbacks_forms.html"><span class="doc">Callbacks and forms</span></a> for more information about actions). This is the <em>callback processing</em> phase.</p>
<p>Finally, Nagare creates a renderer and renders the components tree starting from the root component. This is the <em>rendering</em>
phase. At this point, we are not supposed to change the component graph, but it’s possible nevertheless.</p>
<p>After the rendering, the state of the components is persisted in the session store, which is either in memory, in <a class="reference external" href="http://memcached.org/">memcache</a>,
or not at all, depending on the publisher configuration (see <a class="reference internal" href="publisher_file.html"><span class="doc">The publisher configuration file</span></a>). The session stored can then be
used in the next request to initialize the components before executing the action callback.</p>
<p>The same principles applies when your components are rendered asynchronously (i.e. with an <code class="docutils literal notranslate"><span class="pre">AsyncRenderer</span></code>), except that only
a components subtree is rendered (starting from the asynchronous root) and the same session state is written over and over
instead of creating a new state for each request as in synchronous mode.</p>
<p>To sum up, there are 4 important steps when handling a request:</p>
<ol class="arabic simple">
<li>initialize the components from the session or from the URL (if a new session begins)</li>
<li>update the components tree by processing the action callbacks</li>
<li>render the components tree</li>
<li>save the new state in the session</li>
</ol>
<p>That’s basically what the <code class="docutils literal notranslate"><span class="pre">WSGIApp.__call__</span></code> method does. However, note that there are many hooks called in
this method that can be overridden to customize the application behavior. That’s what we’re going to review now.</p>
</div>
<div class="section" id="customizing-the-wsgiapp">
<h2>Customizing the WSGIApp<a class="headerlink" href="#customizing-the-wsgiapp" title="Permalink to this headline">¶</a></h2>
<p>It’s possible to customize the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> behavior by subclassing the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> class and changing the global <code class="docutils literal notranslate"><span class="pre">app</span></code>
attribute to refer to the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> subclass, as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nagare</span> <span class="kn">import</span> <span class="n">wsgi</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIApp</span><span class="p">):</span>
    <span class="c1"># put your customization code here</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">root_factory</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="n">Component</span><span class="p">(</span><span class="n">Root</span><span class="p">())</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyApp</span><span class="p">(</span><span class="n">root_factory</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> constructor accepts a root component <em>factory</em> as single argument, which is used to create the <em>root
component</em> when a new session begins, that is, the initial state of the application when a new user comes in.</p>
<p>There are many methods that can be overridden in the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code>. Maybe the most important one is <code class="docutils literal notranslate"><span class="pre">WSGIApp.__call__</span></code>
which has already been described: it implements the <a class="reference external" href="http://www.wsgi.org">WSGI protocol</a>. Most of the time, you don’t need to override this
method directly because Nagare provides finer grained methods.</p>
<p>The <a class="reference internal" href="source/nagare.html#nagare.wsgi.WSGIApp.start_request" title="nagare.wsgi.WSGIApp.start_request"><code class="xref py py-class docutils literal notranslate"><span class="pre">nagare.wsgi.WSGIApp.start_request</span></code></a> method is called at the begin of each
incoming request. This is where we can perform reques or session specific initializations such as installing the locale
depending on the user/browser settings, authenticating the user using the credentials sent in the request, initializing
request or session scoped data… The first parameter of this method receives the root component that has just been
created or been initialized from the session, before URL rules are process (i.e. <code class="docutils literal notranslate"><span class="pre">presentation.init</span></code> rules). The last
two parameters are the request and the response objects.</p>
<p>The <a class="reference internal" href="source/nagare.html#nagare.wsgi.WSGIApp.set_config" title="nagare.wsgi.WSGIApp.set_config"><code class="xref py py-class docutils literal notranslate"><span class="pre">nagare.wsgi.WSGIApp.set_config</span></code></a> method is another commonly used method: it’s the
place where the application receives its configuration. You can read custom configuration sections and values in
this method in order to configure the services that you use in your application.</p>
<p>For completeness, here is the full listing of the overridable methods and their purpose:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Purpose</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">__init__(root_factory)</span></code></td>
<td>Constructor, receives the root component factory</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">__call__(environ,</span> <span class="pre">start_response)</span></code></td>
<td>Implements the <a class="reference external" href="http://www.wsgi.org">WSGI protocol</a>. This is the plumbing between
WSGI and the Nagare components</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">_phase1(request,</span> <span class="pre">response,</span> <span class="pre">callbacks)</span></code></td>
<td>Phase 1: processes action callbacks in order to update the
components tree</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">_phase2(output,</span> <span class="pre">content_type,</span> <span class="pre">doctype,</span> <span class="pre">is_xhr,</span> <span class="pre">response)</span></code></td>
<td>Phase 2: renders the components tree</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">create_renderer(async,</span> <span class="pre">session,</span> <span class="pre">request,</span> <span class="pre">response,</span> <span class="pre">callbacks)</span></code></td>
<td>Creates a renderer that will be used to render the components
tree. Internally, it calls the <code class="docutils literal notranslate"><span class="pre">WSGIApp.renderer_factory</span></code>
attribute to create the renderer, which is initialized by
default to <code class="docutils literal notranslate"><span class="pre">xhtml.Renderer</span></code>. So, by default, Nagare uses a
(X)HTML renderer to render the component</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">create_root(*args,</span> <span class="pre">**kw)</span></code></td>
<td>Creates the application root component by using the component
factory passed to the constructor. You can pass parameters to
the root component in this method, such as instances of services
initialized from the application configuration</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">on_after_post(request,</span> <span class="pre">response,</span> <span class="pre">ids)</span></code></td>
<td>Generate a redirection after a POST request if the
<code class="docutils literal notranslate"><span class="pre">redirect_after_post</span></code> option is enabled in the application
configuration. It’s also known as the <a class="reference external" href="http://en.wikipedia.org/wiki/Post/Redirect/Get">PRG Pattern</a></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">on_back(request,</span> <span class="pre">response,</span> <span class="pre">h,</span> <span class="pre">output)</span></code></td>
<td>Called when the user used the back button of his browser</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">on_bad_http_method(request,</span> <span class="pre">response)</span></code></td>
<td>Called when a HTTP request other than a GET or PUT was
received. By default, this method returns a MethodNotAllowed
response</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">on_callback_lookuperror(request,</span> <span class="pre">response,</span> <span class="pre">async)</span></code></td>
<td>A callback was not found: this generally occurs when you use
an asynchronous renderer to update a component on a page but
try to use a (dead) callback (i.e. <code class="docutils literal notranslate"><span class="pre">_actionNNN</span></code>) defined in
an older state of the component</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">on_exception(request,</span> <span class="pre">response)</span></code></td>
<td>Method called when an unhandled exception occurs. Note that
it does not include the exceptions deriving from
<code class="docutils literal notranslate"><span class="pre">webob.exc.HTTPException</span></code> which are used to send special
HTTP responses</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">on_incomplete_url(request,</span> <span class="pre">response)</span></code></td>
<td>An URL without an application name was received</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">on_session_expired(request,</span> <span class="pre">response)</span></code></td>
<td>The session information received is either expired or invalid</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">set_config(config_filename,</span> <span class="pre">config,</span> <span class="pre">error)</span></code></td>
<td>Called when Nagare configures the application from the
application configuration file. You can read you own configuration
keys/values in this method</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">set_data_path(data_path)</span></code></td>
<td>Register the directory where the application data is to be found</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">set_databases(databases)</span></code></td>
<td>Register the databases properties</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">set_default_locale(locale)</span></code></td>
<td>Register the default locale, i.e. the locale used by default in
all requests</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">set_locale(locale)</span></code></td>
<td>Set the locale for the current request</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">set_project(name)</span></code></td>
<td>Register the application distribution name</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">set_publisher(publisher)</span></code></td>
<td>Register the publisher that serves the application to the outside
world (see <a class="reference internal" href="publisher_file.html"><span class="doc">The publisher configuration file</span></a>)</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">set_sessions_manager(sessions_manager)</span></code></td>
<td>Register the sessions manager (see <a class="reference internal" href="publisher_file.html"><span class="doc">The publisher configuration file</span></a>)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">set_static_path(static_path)</span></code></td>
<td>Register the directory of the static contents of the application,
such as Javascript or CSS files</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">set_static_url(static_url)</span></code></td>
<td>Register the URL of the static contents</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">start()</span></code></td>
<td>Called when the publisher starts a new process serving the
application. May be useful to initialize process scoped data.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">start_request(root,</span> <span class="pre">request,</span> <span class="pre">response)</span></code></td>
<td>Called when a new request is received. This method can be used to
access the request data, add some headers in the response or
configure the root component that has just been deserialized from
the session</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="some-examples">
<h2>Some examples<a class="headerlink" href="#some-examples" title="Permalink to this headline">¶</a></h2>
<p>In order to illustrate how to use the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> methods, here are some examples showing how to solve
common use-cases in Nagare applications.</p>
<div class="section" id="reading-a-specific-configuration-section-to-initialize-a-service">
<h3>Reading a specific configuration section to initialize a service<a class="headerlink" href="#reading-a-specific-configuration-section-to-initialize-a-service" title="Permalink to this headline">¶</a></h3>
<p>Imagine that you want to send emails to the visitors of your next Web application. So you need
to be able to configure the host and the port of the SMTP server your Web application will connect to.</p>
<p>In the application configuration file, we can add a specific section that provides the configuration
information for the mail sender service.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[mail]</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">mail.server.com</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">25</span>
</pre></div>
</div>
<p>In order to read this configuration section, we need to override the <code class="docutils literal notranslate"><span class="pre">WSGIApp.set_config</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">configobj</span>
<span class="kn">from</span> <span class="nn">nagare</span> <span class="kn">import</span> <span class="n">wsgi</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">myapp.mailsender</span> <span class="kn">import</span> <span class="n">MailSender</span>

<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIApp</span><span class="p">):</span>
    <span class="n">APPLICATION_SPEC</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mail&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;string(default=&quot;localhost&quot;)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="s1">&#39;integer(default=25)&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="c1"># Call the base implementation</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyApp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>

        <span class="c1"># Parse and convert the SMTP parameters</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">configobj</span><span class="o">.</span><span class="n">ConfigObj</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">configspec</span><span class="o">=</span><span class="n">configobj</span><span class="o">.</span><span class="n">ConfigObj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">APPLICATION_SPEC</span><span class="p">))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>

        <span class="c1"># Create the mail sender service instance</span>
        <span class="n">mail_host</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mail&#39;</span><span class="p">][</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
        <span class="n">mail_port</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mail&#39;</span><span class="p">][</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_sender</span> <span class="o">=</span> <span class="n">MailSender</span><span class="p">(</span><span class="n">mail_host</span><span class="p">,</span> <span class="n">mail_port</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>First, we validate and read the configuration file, then we get the <code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code> values needed
to configure our <code class="docutils literal notranslate"><span class="pre">MailSender</span></code> service. When creating the <code class="docutils literal notranslate"><span class="pre">ConfigObj</span></code> object, we use a <code class="docutils literal notranslate"><span class="pre">configspec</span></code>
to:</p>
<ol class="arabic simple">
<li>validate the correctness of the configuration file</li>
<li>provide “smart” default values for the missing configuration keys</li>
<li>convert the keys to the proper type</li>
</ol>
<p>Now that the mail sender service is created, we must pass it to the Nagare components that need it.
The configured mail sender instance can be passed to the root component by overriding the
<code class="docutils literal notranslate"><span class="pre">WSGIApp.create_root</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIApp</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">create_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyApp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create_root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mail_sender</span><span class="p">)</span>
</pre></div>
</div>
<p>Then the root component can use the mail sender instance or pass it to its children components:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mail_sender</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mail_sender</span> <span class="o">=</span> <span class="n">mail_sender</span>
        <span class="c1"># Do something useful with the mail_sender:</span>
        <span class="c1"># use it in an action callback or pass it to a children component</span>

<span class="k">def</span> <span class="nf">root_factory</span><span class="p">(</span><span class="n">mail_sender</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="n">Component</span><span class="p">(</span><span class="n">Root</span><span class="p">(</span><span class="n">mail_sender</span><span class="p">))</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyApp</span><span class="p">(</span><span class="n">root_factory</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="authenticating-users">
<h3>Authenticating users<a class="headerlink" href="#authenticating-users" title="Permalink to this headline">¶</a></h3>
<p>Nagare applications have no user authentification by default, so all visitors are allowed
to see your application. This default behavior is installed in the <code class="docutils literal notranslate"><span class="pre">WSGIApp</span></code> constructor.
You can change it by creating a custom security manager using one of the authentification
schemes available in the <code class="docutils literal notranslate"><span class="pre">nagare.security</span></code> package (such as a HTTP Basic authentication or
a Form authentication retrieving users from a database).</p>
<p>Then, the custom security manager can be installed either in <code class="docutils literal notranslate"><span class="pre">WSGIApp.__init__</span></code>,
<code class="docutils literal notranslate"><span class="pre">WSGIApp.set_config</span></code> or <code class="docutils literal notranslate"><span class="pre">WSGIApp.start_request</span></code>. Here is an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">myapp.security</span> <span class="kn">import</span> <span class="n">MySecurityManager</span>

<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIApp</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_factory</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">(</span><span class="n">MyApp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root_factory</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="n">MySecurityManager</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-a-locale-in-each-request">
<h3>Installing a locale in each request<a class="headerlink" href="#installing-a-locale-in-each-request" title="Permalink to this headline">¶</a></h3>
<p>Basically, you can change the default locale globally by calling <code class="docutils literal notranslate"><span class="pre">WSGIApp.set_default_locale</span></code>, or
just change the locale for the current request by calling <code class="docutils literal notranslate"><span class="pre">WSGIApp.set_locale</span></code> (according to a user
or session locale setting for example). Some examples can be found in
<a class="reference internal" href="i18n.html"><span class="doc">Internationalization of applications</span></a>.</p>
</div>
<div class="section" id="serving-an-application-in">
<h3>Serving an application in /<a class="headerlink" href="#serving-an-application-in" title="Permalink to this headline">¶</a></h3>
<p>By default, an application named <code class="docutils literal notranslate"><span class="pre">myapp</span></code> is served in <code class="docutils literal notranslate"><span class="pre">/myapp</span></code>, but you may want your application
to respond in the root URL (i.e. <code class="docutils literal notranslate"><span class="pre">/</span></code>) too. To achieve that, you must tell the <code class="docutils literal notranslate"><span class="pre">publisher</span></code> that your
application must be registered to the root URL. This can be done by overriding the
<code class="docutils literal notranslate"><span class="pre">WSGIApp.set_publisher</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIApp</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_publisher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publisher</span><span class="p">):</span>
        <span class="c1"># Call the base implementation</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EurekaBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_publisher</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span>

        <span class="c1"># Register the application in the root URL</span>
        <span class="n">publisher</span><span class="o">.</span><span class="n">register_application</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application_path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the static contents of the application are still be served in <code class="docutils literal notranslate"><span class="pre">/static/myapp</span></code>.</p>
</div>
<div class="section" id="logging-unhandled-exceptions">
<h3>Logging unhandled exceptions<a class="headerlink" href="#logging-unhandled-exceptions" title="Permalink to this headline">¶</a></h3>
<p>We can intercept unhandled exceptions and log them to the application logger by overriding
the <code class="docutils literal notranslate"><span class="pre">WSGIApp.on_exception</span></code> method, as show in the example below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nagare</span> <span class="kn">import</span> <span class="n">log</span>

<span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIApp</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="c1"># Log the current exception (i.e. sys.exc_info())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;An error occured&#39;</span><span class="p">)</span>

        <span class="c1"># Return an internal server error to the client</span>
        <span class="k">return</span> <span class="n">webob</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">HTTPInternalServerError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="i18n.html" class="btn btn-neutral float-right" title="Internationalization of applications" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="restful.html" class="btn btn-neutral" title="Significative “RESTful” URLs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.5.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
   

</body>
</html>